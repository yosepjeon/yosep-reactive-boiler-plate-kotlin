<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Parallel Tasks Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .events-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .event-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
        }
        .event-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 13px;
            word-wrap: break-word;
        }
        .progress { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .complete { background: #fff3cd; border-left: 4px solid #ffc107; }
        .summary {
            background: #e7f3ff;
            border: 1px solid #007bff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        .task-progress {
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected { background: #28a745; color: white; }
        .status.disconnected { background: #dc3545; color: white; }
        .status.connecting { background: #ffc107; color: black; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SSE Parallel Tasks Demo</h1>

        <div class="controls">
            <button id="startBtn" onclick="startSSE()">Start Parallel Tasks</button>
            <button id="stopBtn" onclick="stopSSE()" disabled>Stop</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <span class="status" id="status">disconnected</span>
        </div>

        <div class="task-progress" id="taskProgress"></div>

        <div class="events-container">
            <div>
                <h3>Event Stream</h3>
                <div class="event-log" id="eventLog"></div>
            </div>
            <div>
                <h3>Results</h3>
                <div class="event-log" id="resultsLog"></div>
            </div>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <h3>Execution Summary</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        let eventSource = null;
        const results = {};
        const taskProgress = {};

        function startSSE() {
            if (eventSource) {
                eventSource.close();
            }

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const status = document.getElementById('status');

            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = 'connecting';
            status.className = 'status connecting';

            // SSE 연결 생성
            eventSource = new EventSource('/api/sse/sample-parallel');

            eventSource.onopen = function() {
                status.textContent = 'connected';
                status.className = 'status connected';
                logEvent('System', 'SSE connection established', 'progress');
            };

            // 각 이벤트 타입별 핸들러
            eventSource.addEventListener('progress', function(event) {
                const data = JSON.parse(event.data);
                handleProgress(data);
            });

            eventSource.addEventListener('success', function(event) {
                const data = JSON.parse(event.data);
                handleSuccess(data);
            });

            eventSource.addEventListener('error', function(event) {
                const data = JSON.parse(event.data);
                handleError(data);
            });

            eventSource.addEventListener('complete', function(event) {
                const data = JSON.parse(event.data);
                handleComplete(data);
                stopSSE();
            });

            eventSource.onerror = function(error) {
                console.error('SSE Error:', error);
                status.textContent = 'disconnected';
                status.className = 'status disconnected';
                logEvent('System', 'Connection lost', 'error');
                stopSSE();
            };
        }

        function handleProgress(data) {
            logEvent('Progress', `Task: ${data.taskName} - ${data.status} (${data.progressPercent}%)`, 'progress');
            updateTaskProgress(data.taskId, data.taskName, data.progressPercent);
        }

        function handleSuccess(data) {
            results[data.taskId] = data.result;
            logEvent('Success', `Task: ${data.taskName} completed in ${data.executionTimeMs}ms`, 'success');
            updateTaskProgress(data.taskId, data.taskName, 100);
            displayResult(data.taskId, data.taskName, data.result);
        }

        function handleError(data) {
            results[data.taskId] = { error: data.error };
            logEvent('Error', `Task: ${data.taskName} failed - ${data.error}`, 'error');
            displayResult(data.taskId, data.taskName, { error: data.error });
        }

        function handleComplete(data) {
            logEvent('Complete', `All tasks finished. Success: ${data.successCount}/${data.totalTasks}`, 'complete');
            displaySummary(data);
        }

        function updateTaskProgress(taskId, taskName, percent) {
            if (!taskProgress[taskId]) {
                const progressContainer = document.getElementById('taskProgress');
                const taskDiv = document.createElement('div');
                taskDiv.innerHTML = `
                    <div style="margin: 5px 0;">
                        <span style="font-size: 12px;">${taskName}</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-${taskId}" style="width: 0%">0%</div>
                        </div>
                    </div>
                `;
                progressContainer.appendChild(taskDiv);
                taskProgress[taskId] = true;
            }

            const progressBar = document.getElementById(`progress-${taskId}`);
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}%`;
            }
        }

        function logEvent(type, message, className) {
            const eventLog = document.getElementById('eventLog');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event-item ${className}`;
            const timestamp = new Date().toLocaleTimeString();
            eventDiv.innerHTML = `
                <strong>[${timestamp}] ${type}:</strong><br>
                ${message}
            `;
            eventLog.insertBefore(eventDiv, eventLog.firstChild);
        }

        function displayResult(taskId, taskName, result) {
            const resultsLog = document.getElementById('resultsLog');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'event-item';
            resultDiv.innerHTML = `
                <strong>${taskName} (${taskId}):</strong>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            resultsLog.insertBefore(resultDiv, resultsLog.firstChild);
        }

        function displaySummary(data) {
            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');

            summary.style.display = 'block';
            summaryContent.innerHTML = `
                <p><strong>Total Tasks:</strong> ${data.totalTasks}</p>
                <p><strong>Successful:</strong> ${data.successCount}</p>
                <p><strong>Failed:</strong> ${data.errorCount}</p>
                <p><strong>Total Time:</strong> ${data.totalExecutionTimeMs}ms</p>
                <details>
                    <summary>Aggregated Results</summary>
                    <pre>${JSON.stringify(data.aggregatedResults, null, 2)}</pre>
                </details>
            `;
        }

        function stopSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const status = document.getElementById('status');

            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'disconnected';
            status.className = 'status disconnected';
        }

        function clearLogs() {
            document.getElementById('eventLog').innerHTML = '';
            document.getElementById('resultsLog').innerHTML = '';
            document.getElementById('taskProgress').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            Object.keys(taskProgress).forEach(key => delete taskProgress[key]);
        }

        // 커스텀 태스크 실행
        async function executeCustomTasks() {
            const tasks = [
                {
                    id: "task1",
                    name: "API Call 1",
                    url: "https://jsonplaceholder.typicode.com/users/1",
                    timeoutMs: 5000
                },
                {
                    id: "task2",
                    name: "API Call 2",
                    url: "https://jsonplaceholder.typicode.com/posts/1",
                    timeoutMs: 5000
                }
            ];

            const response = await fetch('/api/sse/parallel-tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tasks })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                console.log('Received chunk:', chunk);
            }
        }
    </script>
</body>
</html>